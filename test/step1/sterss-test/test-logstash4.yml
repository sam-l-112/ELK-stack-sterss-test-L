apiVersion: logstash.k8s.elastic.co/v1alpha1
kind: Logstash
metadata:
  name: quickstart
spec:
  version: 8.19.2
  count: 3

  elasticsearchRefs:
    - name: quickstart
      clusterName: qs

  services:
    - name: beats
      service:
        spec:
          type: ClusterIP
          ports:
            - port: 5044
              name: "filebeat"
              protocol: TCP

  config:
    log.level: info
    queue.type: memory # Enable persistent queue to handle backpressure
    queue.max_bytes: 1gb # Increase queue size for high throughput
    pipeline.batch.size: 125 # Default batch size for Elasticsearch output
    pipeline.batch.delay: 20 # Delay in ms for batching
    pipeline.workers: 4

  pipelines:
    - pipeline.id: main
      pipeline.workers: 4
      config.string: |
        input {
          generator {
            message => "Hello world!"
            count => 0
            threads => 2000
          }
          beats {
            port => 5044
            ecs_compatibility => "disabled"  # 添加相容性設置
          }
        }
        output {
          elasticsearch {
            hosts => ["${QS_ES_HOSTS}"]
            index => "logstash-%{+YYYY.MM.dd}"
            user => "${QS_ES_USER}"
            password => "${QS_ES_PASSWORD}"
            cacert => "/usr/share/logstash/config/certs/ca.crt"
            ecs_compatibility => "disabled"
          }
        }
        
  podTemplate:
    metadata:
      labels:
        app: logstash
      annotations:
        prometheus.io/scrape: "true" # Enable Prometheus scraping
        prometheus.io/port: "9600" # Logstash monitoring port
    spec:
      containers:
        - name: logstash
          resources:
            requests:
              cpu: "1" # 2 CPU cores for stress testing
              memory: "6Gi" # 4GB memory
            limits:
              cpu: "2" # Allow up to 4 CPU cores
              memory: "8Gi" # Allow up to 8GB memory
          env:
            - name: JAVA_OPTS
              value: "-Xms4g -Xmx6g" # JVM heap settings for high throughput
            - name: QS_ES_HOSTS
              value: "https://quickstart-es-http.default.svc:9200"
            - name: QS_ES_USER
              value: "default-quickstart-default-quickstart-logstash-user"
            - name: QS_ES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: quickstart-default-quickstart-logstash-user
                  key: default-quickstart-default-quickstart-logstash-user
            - name: QS_ES_SSL_CERTIFICATE_AUTHORITY
              value: "/usr/share/logstash/config/certs/ca.crt"
          volumeMounts:
            - name: elasticsearch-certs
              mountPath: "/usr/share/logstash/config/certs"
              readOnly: true
      volumes:
        - name: elasticsearch-certs
          secret:
            secretName: quickstart-es-http-certs-public